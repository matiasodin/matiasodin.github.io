<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Plataforma de Addons STTF</title>
<style>
  :root {
    --primary: #4f46e5;
    --bg-color: #000000;
    --text-color: #111827;
    --card-bg: white;
  }
  body {
    margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: var(--bg-color);
    color: var(--text-color);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }
  header {
    background: var(--primary);
    color: white;
    padding: 1em 2em;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  header h1 {
    margin: 0;
    font-weight: 700;
  }
  header button {
    background: white;
    color: var(--primary);
    border: none;
    padding: 0.5em 1em;
    font-weight: 600;
    border-radius: 5px;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  header button:hover {
    background: #ddd;
  }

  main {
    flex: 1;
    max-width: 900px;
    margin: 2em auto;
    width: 90%;
  }

  /* Login form */
  #loginPage {
    max-width: 400px;
    margin: 8em auto;
    padding: 2em;
    background: white;
    border-radius: 10px;
    box-shadow: 0 0 15px rgb(0 0 0 / 0.1);
  }
  #loginPage h2 {
    text-align: center;
    margin-bottom: 1.5em;
    font-weight: 700;
  }
  #loginPage input[type="email"] {
    width: 100%;
    padding: 0.6em;
    font-size: 1em;
    margin-bottom: 1.2em;
    border: 1px solid #ccc;
    border-radius: 6px;
  }
  #loginPage button {
    width: 100%;
    padding: 0.7em;
    font-weight: 700;
    font-size: 1em;
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: background-color 0.25s ease;
  }
  #loginPage button:hover {
    background: #4338ca;
  }
  #loginError {
    color: #dc2626;
    height: 1.2em;
    margin-bottom: 1em;
    text-align: center;
  }

  /* Perfil */
  #profilePanel {
    position: fixed;
    top: 5em;
    right: -320px;
    width: 300px;
    background: var(--card-bg);
    box-shadow: 0 0 15px rgb(0 0 0 / 0.2);
    border-radius: 12px;
    padding: 1em;
    transition: right 0.35s ease;
    z-index: 100;
  }
  #profilePanel.open {
    right: 1em;
  }
  #profilePanel h3 {
    margin-top: 0;
    text-align: center;
  }
  #profilePanel img {
    display: block;
    margin: 0 auto 1em;
    width: 110px;
    height: 110px;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid var(--primary);
  }
  #profilePanel input[type="file"],
  #profilePanel input[type="url"] {
    width: 100%;
    margin-bottom: 0.8em;
    border-radius: 6px;
    border: 1px solid #ccc;
    padding: 0.4em;
  }
  #profilePanel button {
    width: 100%;
    padding: 0.6em;
    background: var(--primary);
    color: white;
    font-weight: 700;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    margin-bottom: 0.5em;
  }

  /* Bot√≥n abrir perfil */
  #btnToggleProfile {
    position: fixed;
    top: 5em;
    right: 1em;
    background: var(--primary);
    color: white;
    border-radius: 50%;
    width: 48px;
    height: 48px;
    font-size: 24px;
    line-height: 48px;
    text-align: center;
    cursor: pointer;
    box-shadow: 0 0 8px var(--primary);
    transition: background-color 0.3s ease;
    z-index: 101;
  }
  #btnToggleProfile:hover {
    background: #4338ca;
  }

  /* Zona subida addons */
  #addonsSection {
    margin-top: 2em;
  }
  #btnNewAddon {
    background: var(--primary);
    color: white;
    font-weight: 700;
    border: none;
    border-radius: 50%;
    width: 56px;
    height: 56px;
    font-size: 32px;
    cursor: pointer;
    position: fixed;
    bottom: 2em;
    right: 2em;
    box-shadow: 0 0 15px var(--primary);
    transition: background-color 0.3s ease;
    z-index: 200;
  }
  #btnNewAddon:hover {
    background: #4338ca;
  }

  /* Modal para nuevo addon */
  #modalNewAddon {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    backdrop-filter: blur(3px);
    justify-content: center;
    align-items: center;
    z-index: 300;
  }
  #modalNewAddon.active {
    display: flex;
  }
  #modalContent {
    background: white;
    border-radius: 12px;
    padding: 2em;
    max-width: 400px;
    width: 90%;
    box-shadow: 0 0 20px rgb(0 0 0 / 0.25);
  }
  #modalContent h3 {
    margin-top: 0;
    margin-bottom: 1em;
    text-align: center;
  }
  #modalContent input[type="text"],
  #modalContent textarea,
  #modalContent input[type="file"] {
    width: 100%;
    margin-bottom: 1em;
    padding: 0.5em;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-size: 1em;
  }
  #modalContent textarea {
    resize: vertical;
    min-height: 70px;
  }
  #modalContent button {
    background: var(--primary);
    color: white;
    border: none;
    padding: 0.7em 1em;
    font-weight: 700;
    border-radius: 8px;
    cursor: pointer;
    width: 100%;
  }
  #modalContent button:hover {
    background: #4338ca;
  }
  #modalCloseBtn {
    margin-top: 0.5em;
    background: #ef4444;
  }

  /* Lista addons */
  #addonsList {
    margin-top: 2em;
    display: grid;
    gap: 1em;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  }
  .addonCard {
    background: var(--card-bg);
    padding: 1em;
    border-radius: 12px;
    box-shadow: 0 0 8px rgb(0 0 0 / 0.1);
    display: flex;
    flex-direction: column;
  }
  .addonImg {
    max-height: 150px;
    object-fit: contain;
    margin-bottom: 1em;
    border-radius: 8px;
  }
  .addonName {
    font-weight: 700;
    font-size: 1.1em;
    margin-bottom: 0.5em;
  }
  .addonDesc {
    flex-grow: 1;
    margin-bottom: 1em;
    white-space: pre-wrap;
  }
  .addonFileLink {
    color: var(--primary);
    font-weight: 700;
    text-decoration: none;
    margin-bottom: 1em;
  }
  .addonFileLink:hover {
    text-decoration: underline;
  }
  .addonActions {
    display: flex;
    justify-content: space-between;
  }
  .likeBtn {
    background: #ef4444;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    padding: 0.3em 0.8em;
    font-weight: 700;
    transition: background-color 0.3s ease;
  }
  .likeBtn.liked {
    background: #b91c1c;
  }

  /* Buscador */
  #searchInput {
    width: 100%;
    padding: 0.5em 1em;
    font-size: 1em;
    border-radius: 10px;
    border: 1px solid #ddd;
    box-shadow: inset 0 0 8px rgb(0 0 0 / 0.1);
  }
  #searchContainer {
    margin-bottom: 1em;
  }

  /* Animaciones */
  .fadeIn {
    animation: fadeInAnim 0.5s ease forwards;
  }
  @keyframes fadeInAnim {
    from {opacity: 0;}
    to {opacity: 1;}
  }

  /* Responsive */
  @media (max-width: 480px) {
    #profilePanel {
      width: 90vw;
      right: -100vw;
    }
    #profilePanel.open {
      right: 5vw;
    }
    #btnToggleProfile {
      top: 4em;
      right: 5vw;
    }
    #btnNewAddon {
      bottom: 1em;
      right: 1em;
    }
  }
</style>
</head>
<body>

  <!-- P√°gina Login -->
  <section id="loginPage" aria-label="Formulario de inicio de sesi√≥n">
    <h2>Iniciar sesi√≥n</h2>
    <div id="loginError" role="alert" aria-live="assertive"></div>
    <input type="email" id="loginEmail" placeholder="Correo electr√≥nico @gmail.com" aria-label="Correo electr√≥nico para iniciar sesi√≥n" required />
    <button id="btnLogin">Entrar</button>
  </section>

  <!-- Perfil -->
  <aside id="profilePanel" aria-label="Panel de perfil de usuario">
    <h3>Perfil</h3>
    <img id="profileImage" alt="Foto de perfil" src="https://i.pravatar.cc/150?u=default" />
    <input type="file" id="profileImageFile" accept="image/*" aria-label="Subir foto de perfil" />
    <input type="url" id="profileImageUrl" placeholder="URL de imagen de perfil" aria-label="URL de imagen de perfil" />
    <button id="btnSaveProfile">Guardar Perfil</button>
  </aside>

  <!-- Bot√≥n abrir/cerrar perfil -->
  <button id="btnToggleProfile" aria-expanded="false" aria-controls="profilePanel" aria-label="Abrir o cerrar panel de perfil">üë§</button>

  <header>
    <h1>STTF Addons</h1>
    <button id="btnLogout" style="display:none;">Cerrar sesi√≥n</button>
  </header>

  <main aria-live="polite">
    <div id="searchContainer">
      <input type="search" id="searchInput" placeholder="Buscar addons por nombre o descripci√≥n..." aria-label="Buscar addons" />
    </div>

    <section id="addonsSection" aria-label="Zona de addons">
      <div id="addonsList"></div>
    </section>
  </main>

  <!-- Bot√≥n nuevo addon -->
  <button id="btnNewAddon" title="Subir nuevo addon" aria-haspopup="dialog" aria-controls="modalNewAddon">+</button>

  <!-- Modal nuevo addon -->
  <div id="modalNewAddon" role="dialog" aria-modal="true" aria-labelledby="modalNewAddonTitle" tabindex="-1">
    <div id="modalContent">
      <h3 id="modalNewAddonTitle">Subir Nuevo Addon</h3>
      <input type="text" id="addonName" placeholder="Nombre del addon" aria-label="Nombre del addon" required />
      <textarea id="addonDesc" placeholder="Descripci√≥n del addon" aria-label="Descripci√≥n del addon" required></textarea>
      <input type="file" id="addonFile" accept=".mcpack,.mcaddon,.zip" aria-label="Archivo del addon (.mcpack, .mcaddon, .zip)" required />
      <input type="url" id="addonImageUrl" placeholder="URL de imagen del addon (opcional)" aria-label="URL de imagen del addon" />
      <button id="btnSubmitAddon">Publicar Addon</button>
      <button id="btnCloseModal" style="background:#ef4444; margin-top:0.5em;">Cancelar</button>
    </div>
  </div>

<script>
(() => {
  // Elementos
  const loginPage = document.getElementById('loginPage');
  const loginEmail = document.getElementById('loginEmail');
  const btnLogin = document.getElementById('btnLogin');
  const loginError = document.getElementById('loginError');

  const profilePanel = document.getElementById('profilePanel');
  const btnToggleProfile = document.getElementById('btnToggleProfile');
  const profileImage = document.getElementById('profileImage');
  const profileImageFile = document.getElementById('profileImageFile');
  const profileImageUrl = document.getElementById('profileImageUrl');
  const btnSaveProfile = document.getElementById('btnSaveProfile');

  const btnLogout = document.getElementById('btnLogout');

  const btnNewAddon = document.getElementById('btnNewAddon');
  const modalNewAddon = document.getElementById('modalNewAddon');
  const btnCloseModal = document.getElementById('btnCloseModal');
  const btnSubmitAddon = document.getElementById('btnSubmitAddon');
  const addonName = document.getElementById('addonName');
  const addonDesc = document.getElementById('addonDesc');
  const addonFile = document.getElementById('addonFile');
  const addonImageUrl = document.getElementById('addonImageUrl');

  const addonsList = document.getElementById('addonsList');
  const searchInput = document.getElementById('searchInput');

  // Variables
  let currentUser = null;
  let addons = [];

  // --- FUNCIONES UTILES ---
  // Validar email @gmail.com
  function validarEmailGmail(email) {
    return /^[\w.+-]+@gmail\.com$/i.test(email);
  }
  // Leer archivo como base64 para imagen perfil o addon
  function fileToBase64(file) {
    return new Promise((res, rej) => {
      const reader = new FileReader();
      reader.onload = () => res(reader.result);
      reader.onerror = () => rej('Error leyendo archivo');
      reader.readAsDataURL(file);
    });
  }
  // Guardar session usuario
  function guardarSesion(user) {
    localStorage.setItem('sttfUser', JSON.stringify(user));
  }
  // Cargar session usuario
  function cargarSesion() {
    const data = localStorage.getItem('sttfUser');
    if (!data) return null;
    try { return JSON.parse(data);} catch {return null;}
  }
  // Guardar addons
  function guardarAddons() {
    localStorage.setItem('sttfAddons', JSON.stringify(addons));
  }
  // Cargar addons
  function cargarAddons() {
    const data = localStorage.getItem('sttfAddons');
    if (!data) return [];
    try {return JSON.parse(data);} catch {return [];}
  }

  // Renderizar lista addons con filtro opcional
  function renderAddons(filter='') {
    addonsList.innerHTML = '';
    const filterLow = filter.toLowerCase();
    const filtered = addons.filter(a =>
      a.name.toLowerCase().includes(filterLow) || a.description.toLowerCase().includes(filterLow)
    );
    if(filtered.length === 0){
      addonsList.innerHTML = '<p style="text-align:center; color:#666;">No hay addons que coincidan con la b√∫squeda.</p>';
      return;
    }
    filtered.forEach((addon, i) => {
      const card = document.createElement('div');
      card.className = 'addonCard fadeIn';
      card.innerHTML = `
        <img class="addonImg" src="${addon.image || 'https://via.placeholder.com/280x150?text=Addon'}" alt="Imagen addon ${addon.name}" />
        <div class="addonName">${addon.name}</div>
        <div class="addonDesc">${addon.description}</div>
        <a href="${addon.fileData}" download="${addon.name}" class="addonFileLink" aria-label="Descargar addon ${addon.name}">Descargar Addon</a>
        <div class="addonActions">
          <button class="likeBtn ${addon.liked ? 'liked' : ''}" aria-pressed="${addon.liked ? 'true' : 'false'}" aria-label="${addon.liked ? 'Quitar like' : 'Dar like'}">‚ù§ ${addon.likes || 0}</button>
        </div>
      `;
      const likeBtn = card.querySelector('.likeBtn');
      likeBtn.addEventListener('click', () => {
        addon.liked = !addon.liked;
        addon.likes = addon.likes || 0;
        if(addon.liked) addon.likes++;
        else addon.likes--;
        guardarAddons();
        renderAddons(searchInput.value);
      });
      addonsList.appendChild(card);
    });
  }

  // Actualizar foto perfil en UI y guardar
  async function actualizarFotoPerfil() {
    if(profileImageFile.files[0]){
      try {
        const base64 = await fileToBase64(profileImageFile.files[0]);
        profileImage.src = base64;
        currentUser.profileImage = base64;
        guardarSesion(currentUser);
      } catch(e) {
        alert('Error cargando imagen');
      }
    } else if(profileImageUrl.value.trim()) {
      profileImage.src = profileImageUrl.value.trim();
      currentUser.profileImage = profileImage.src;
      guardarSesion(currentUser);
    }
  }

  // Mostrar panel perfil
  function toggleProfilePanel() {
    const expanded = btnToggleProfile.getAttribute('aria-expanded') === 'true';
    if(expanded){
      profilePanel.classList.remove('open');
      btnToggleProfile.setAttribute('aria-expanded', 'false');
    } else {
      profilePanel.classList.add('open');
      btnToggleProfile.setAttribute('aria-expanded', 'true');
      profileImageFile.value = '';
      profileImageUrl.value = '';
    }
  }

  // Mostrar interfaz principal tras login
  function mostrarInterfazPrincipal() {
    loginPage.style.display = 'none';
    btnLogout.style.display = 'inline-block';
    btnToggleProfile.style.display = 'inline-block';
    document.querySelector('main').style.display = 'block';
  }
  // Ocultar interfaz principal, mostrar login
  function mostrarLogin() {
    loginPage.style.display = 'block';
    btnLogout.style.display = 'none';
    btnToggleProfile.style.display = 'none';
    document.querySelector('main').style.display = 'none';
    profilePanel.classList.remove('open');
    btnToggleProfile.setAttribute('aria-expanded', 'false');
  }

  // --- EVENTOS ---

  // Login
  btnLogin.addEventListener('click', (e) => {
    e.preventDefault();
    const email = loginEmail.value.trim();
    if(!validarEmailGmail(email)) {
      loginError.textContent = 'Debes usar un correo @gmail.com v√°lido.';
      return;
    }
    loginError.textContent = '';
    // Cargar sesi√≥n
    currentUser = cargarSesion() || { email, profileImage: 'https://i.pravatar.cc/150?u=' + encodeURIComponent(email) };
    // Actualizar foto perfil UI
    profileImage.src = currentUser.profileImage || 'https://i.pravatar.cc/150?u=' + encodeURIComponent(email);
    guardarSesion(currentUser);
    mostrarInterfazPrincipal();
    renderAddons();
  });

  // Logout
  btnLogout.addEventListener('click', () => {
    localStorage.removeItem('sttfUser');
    currentUser = null;
    mostrarLogin();
  });

  // Abrir/Cerrar perfil
  btnToggleProfile.addEventListener('click', () => toggleProfilePanel());

  // Guardar perfil
  btnSaveProfile.addEventListener('click', async () => {
    await actualizarFotoPerfil();
    alert('Perfil guardado!');
    toggleProfilePanel();
  });

  // Abrir modal nuevo addon
  btnNewAddon.addEventListener('click', () => {
    addonName.value = '';
    addonDesc.value = '';
    addonFile.value = '';
    addonImageUrl.value = '';
    modalNewAddon.classList.add('active');
    addonName.focus();
  });
  // Cerrar modal
  btnCloseModal.addEventListener('click', () => {
    modalNewAddon.classList.remove('active');
  });

  // Subir nuevo addon
  btnSubmitAddon.addEventListener('click', async () => {
    const name = addonName.value.trim();
    const desc = addonDesc.value.trim();
    const file = addonFile.files[0];
    const imageUrl = addonImageUrl.value.trim();

    if(!name || !desc || !file) {
      alert('Completa todos los campos obligatorios.');
      return;
    }

    let fileData;
    try {
      fileData = await fileToBase64(file);
    } catch {
      alert('Error leyendo archivo addon');
      return;
    }

    const newAddon = {
      id: Date.now(),
      name,
      description: desc,
      fileData,
      image: imageUrl || null,
      likes: 0,
      liked: false,
      uploader: currentUser.email,
    };

    addons.push(newAddon);
    guardarAddons();
    renderAddons(searchInput.value);
    modalNewAddon.classList.remove('active');
    alert('Addon subido con √©xito');
  });

  // Buscar addons
  searchInput.addEventListener('input', e => {
    renderAddons(e.target.value);
  });

  // Carga inicial
  window.addEventListener('load', () => {
    addons = cargarAddons();
    currentUser = cargarSesion();
    if(currentUser){
      mostrarInterfazPrincipal();
      profileImage.src = currentUser.profileImage || 'https://i.pravatar.cc/150?u=' + encodeURIComponent(currentUser.email);
      renderAddons();
    } else {
      mostrarLogin();
    }
  });

})();
</script>

</body>
</html>
